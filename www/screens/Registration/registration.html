<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../../ui-kit/css/bootstrap.css">
    <link rel="stylesheet" href="../../ui-kit/css/styles.css">
    <link rel="stylesheet" href="style.css">

    <title>Registration</title>
</head>

<body
    style="background:url(../../ui-kit/svg/orange_background.svg); background-repeat: repeat-y; background-position: center; background-size:100%;">
    <div class="login-container"
        style="display:flex; flex-direction: column; align-items:center; justify-content:center;">
        <div class="mb-3">
            <h3 class="text-bold" style="color:white">
                Регистрация
            </h3>
        </div>
        <div class="mb-3 input-field">
            <input type="email" class="form-control line-success" id="name_input" placeholder="Имя Фамилия">
        </div>

        <div class="mb-3 input-field  ">
            <input type="email" class="form-control line-success" id="email_input" placeholder="name@gmail.com">
        </div>

        <div class="mb-3 nav-item dropdown input-field" id="city-block"
            style="background-color: transparent; width: 100%; display:block;">
            <div style="height: 42px; border:0; width:100%; background-color: transparent;">
                <select class="form-select" style="padding-left:2.5rem;" id="city">
                    <option value="0">Ярославль</option>
                    <option value="1">Екатеринбург</option>
                    <option value="2">Москва</option>
                    <option value="3">Нижний Новгород</option>
                </select>
            </div>

        </div>

        <div class="mb-3 input-field">
            <input type="password" class="form-control" id="password_field_1" placeholder="Пароль">
        </div>

        <div class="mb-3 input-field">
            <input type="password" class="form-control" id="password_field_2" placeholder="Повторите пароль">
        </div>

        <div class="form-check form-check-inline" style="align-self: flex-start;">
            <input class="form-check-input" type="checkbox" id="checkbox-password" value="option1"
                style="flex-grow: 0;">
            <label class="form-check-label" for="inlineCheckbox1" style="color:white;">Показать пароль</label>
        </div>
        <div class="spacer"></div>
        <div class="button-footer" style="display:flex; flex-direction: column; align-content: center;">
            <div class="d-inline-flex align-items-center" id="error-msg">
                <div class="danger-icon"></div>
                <div id="error-msg-text" style="color:white">Что-то пошло не так...</div>
            </div>
            <button class="btn btn-hollow mb-3" id="login_button" onclick="register()"
                style="border-radius:12px; margin-top: 4rem;" disabled>
                <p class="btn-text">Зарегистрироваться</p>
            </button>
            <button class="btn btn-hollow" onclick="location.href='../loginka/loginka.html'">
                <p class="btn-text">Отменить</p>
            </button>


        </div>
        <p style="max-width: fit-content;
        width: 264px;
        height: 22px;
        margin-top: 1rem;
        font-family: gilroy;
        font-style: normal;
        font-weight: normal;
        font-size: 12px;
        line-height: 12px;

        color: rgba(255, 255, 255, 0.55);">Регистрируясь вы соглашаетесь с условиями использования и передачей данных
        </p>
    </div>
    <script>
        var styleElem = document.head.appendChild(document.createElement("style"));

        const validateEmail = (email) => {
            var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        };
        nameField = document.getElementById("name_input");
        checkBoxPassword = document.getElementById("checkbox-password");
        emailField = document.getElementById("email_input");
        passwordField = document.getElementById("password_field_1");
        nameField = document.getElementById("name_input")
        passwordFieldRepeat = document.getElementById("password_field_2");
        loginButton = document.getElementById("login_button");
        // cityDropdown = document.getElementById("cityDropdown");
        const callbackFunction = function () {
            emailField.classList.remove("line-success");
            emailField.classList.remove("line-danger");
            passwordField.classList.remove("line-success");
            passwordFieldRepeat.classList.remove("line-danger");
            passwordFieldRepeat.classList.remove("line-success");
            nameField.classList.remove("line-success");
            nameField.closest(".input-field").classList.add("hide-before");
            emailField.closest(".input-field").classList.add("hide-before");
            passwordField.closest(".input-field").classList.add("hide-before");
            passwordFieldRepeat.closest(".input-field").classList.add("hide-before");
            loginButton.disabled = true;



            console.log(emailField.value);

            a = passwordField.value.length > 3 && passwordFieldRepeat.value == passwordField.value
            b = validateEmail(emailField.value)
            c = nameField.value.length > 2

            if (c) {
                nameField.classList.add("line-success");
                nameField.closest(".input-field").classList.remove("hide-before");

            }
            if (passwordField.value.length > 3) {
                passwordField.closest(".input-field").classList.remove("hide-before");

                passwordField.classList.add("line-success");
            }
            if (b) {
                emailField.closest(".input-field").classList.remove("hide-before");
                emailField.classList.add("line-success");

            } else if (emailField.value) {
                emailField.classList.add("line-danger");
            };
            if (a) {
                passwordFieldRepeat.closest(".input-field").classList.remove("hide-before");

                passwordFieldRepeat.classList.add("line-success");
            }
            if (passwordFieldRepeat.value != passwordField.value) {
                passwordFieldRepeat.classList.add("line-danger");
            }
            if (a && b && c) {
                loginButton.disabled = false;
            }


        };
        emailField.onchange = callbackFunction;
        passwordField.onchange = callbackFunction;
        passwordFieldRepeat.onchange = callbackFunction;
        nameField.onchange = callbackFunction;

        checkBoxPassword.onchange = function () {
            console.log(checkBoxPassword.checked);
            if (checkBoxPassword.checked) {
                passwordField.setAttribute("type", "email");
                passwordFieldRepeat.setAttribute("type", "email");

            } else {
                passwordField.setAttribute("type", "password");
                passwordFieldRepeat.setAttribute("type", "password");
            }
        }

        callbackFunction();
    </script>

</body>
<script>
    emailField = document.getElementById("email_input");


</script>
<script src="../../cordova.js"></script>
<script>
    errorMessage = document.getElementById("error-msg");
    errorMessage.style.visibility = "hidden";

    function register(name, email, password) {
        errorMessage.style.visibility = "hidden";

        if (!email) email = emailField.value;
        if (!password) password = passwordField.value;
        if (!name) name = nameField.value;

        var a = create_user(name, email, password);
        if (a) {
            setTimeout(()=>{
                api_authorize(email, password, '../Profile-main/profile-main.html');
            },1000);
        } else {
            errorMessage.style.visibility = "visible";

        }
    }

    function create_user(name, mail, pass) {
        var success = true;
        cordovaHTTP.post("https://trip.backend.xredday.ru/",
            {
                'request':
                {
                    "action": "reg",
                    "data": {
                        "name": name,
                        "mail": mail,
                        "pass": pass,
                    }
                }
            },
            {},
            function (response) {
                // prints 200
                console.log(response.status);
                console.log("--- RESPONSE DATA START ---\n" + response.data + "\n--- RESPONSE DATA END ---");

                success = true;
            },
            function (response) {
                // prints 403
                console.log(response.status);
                console.log(response.data);
                errorMessage.style.visibility = "visible";
                success = false;
            }
        );
        return success;
    }

    function api_authorize(email, password, href) {
        // Recieves email and password in plain.

        cordovaHTTP.post("https://trip.backend.xredday.ru/",
            {
                'request':
                {
                    "action": "login",
                    "data": { "login": email, "pass": password }
                }
            },
            {},
            function (response) {
                // prints 200
                console.log(response.status);

                try {
                    console.log(response.data);
                    localStorage.setItem("auth_key", response.data);
                    if (response.data) {
                        window.location.href = href;
                    }
                } catch (e) {
                    console.error("JSON parsing error");
                }
            },
            function (response) {
                // prints 403
                console.log("--- AUTH FAIL ---\n")
                console.log(response.status);
                console.log(response.data);
                errorMessage.style.visibility = "visible";
                //prints Permission denied


            }
        );

    }
</script>

</html>