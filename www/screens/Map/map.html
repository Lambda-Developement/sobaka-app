<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../ui-kit/css/bootstrap.css">
    <link rel="stylesheet" href="../../ui-kit/css/styles.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="../../ui-kit/css/leaflet.css" />
    <link rel="stylesheet" href="../../ui-kit/css/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="../../ui-kit/css/MarkerCluster.css" />
    <link rel="stylesheet" href="../../ui-kit/css/MarkerCluster.Default.css" />
    <script src="../../ui-kit/js/leaflet.js"></script>
    <script src="../../ui-kit/js/leaflet-routing-machine.js"></script>
    <script src="../../ui-kit/js/leaflet.markercluster.js"></script>
    <script src="../../ui-kit/js/elasticlunr.js"></script>
    <script src="../../ui-kit/js/lunr.stemmer.support.js"></script>
    <script src="../../ui-kit/js/lunr.ru.js"></script>
    <title>Home</title>

</head>

<body onload="update_zoom()" style="z-index: -2;">
    <div id="map" style="z-index: 0">
    </div>
    <div id="icons-here">
        <!--        <div style="top: 30%;right: 20%" class="my-position d-flex justify-content-center align-items-center">-->
        <!--            <div class="orange-circle"></div>-->
        <!--        </div>-->
        <!--        <div style="top:30%;left:40%;" class="position-fixed">-->
        <!--            <a href="#" onclick="collapse_toggle()">-->
        <!--                <div class="geopoint d-flex justify-content-center align-items-center pb-2 ">-->
        <!--                    <div class="dog-img"></div>-->
        <!--                </div>-->
        <!--            </a>-->
        <!--        </div>-->
    </div>
    <footer class="nav-bar">
        <button class="nav-bar__element active">
            <img src="../../ui-kit/svg/orange_search.svg" alt="search_ico" class="nav-bar__element__icon">
            <div class="nav-bar__element__title">Поиск</div>
        </button>
        <button class="nav-bar__element" onclick="redirect_profile()">
            <img src="../../ui-kit/svg/profile_icon.svg" alt="search_ico" class="nav-bar__element__icon">
            <div class="nav-bar__element__title">Профиль</div>
        </button>
        <button class="nav-bar__element" onclick="redirect_routes()">
            <img src="../../ui-kit/svg/routes_grey.svg" alt="search_ico" class="nav-bar__element__icon">
            <div class="nav-bar__element__title">Маршруты</div>
        </button>
    </footer>
    <div class="search-bar-wrapper" style="z-index: 10;">
        <div class="search-bar d-inline-flex justify-content-between align-items-center container-fluid">
            <div id="search-icon" class="grey-search-icon" onclick="search_history_close()"></div>
            <div class="w-100"><input onclick="search_history_open()" type="email" class="form-control" id="line-edit"
                    placeholder="Поиск..."></div>
            <div><a href="#">
                    <!-- <div class="menu-icon"></div> -->
                </a></div>
        </div>
    </div>
    <div class="buttons-bar h-100 d-flex flex-column align-items-center justify-content-center" style="z-index: 2;">
        <div id="zoomControl">
            <div class="mb-2">
                <button class="btn btn-hollow btn-gps btn-plus" onclick="zoomin()">
                </button>
            </div>
            <div class="mb-5">
                <button class="btn btn-hollow btn-gps btn-minus" onclick="zoomout()">
                </button>
            </div>
        </div>
        <div>
            <button class="btn btn-hollow btn-gps" onclick="get_location()">
            </button>
        </div>
    </div>
    <div id="info">
        <div class="geopoint-popup d-flex flex-column justify-content-center align-items-center">
            <div onclick="redirect_geoinfo()"
                class="geopoint-info d-flex align-items-center justify-content-between p-3">
                <div class="d-flex flex-column me-3">
                    <div>
                        <h3 class="text-bold" id="info-name">Памятник медведю "Символ России, легенда Ярославля"</h3>
                    </div>
                    <div>
                        <h3 class="text-description" id="info-description">Россия, Ярославль, улица Которосльная
                            набережная</h3>
                    </div>
                    <div>
                        <h3 class="text-description" id="info-distance">0,6 km от вас</h3>
                    </div>
                </div>
                <div class="geopoint-photo" id="info-photo"></div>
            </div>
            <div class="reviews d-inline-flex justify-content-between p-2">
                <div class="d-inline-flex justify-content-center align-items-center me-4">
                    <div class="d-inline-flex justify-content-center align-items-center">
                        <div style="margin-right: 10px;">
                            <h3 class="text-attention" id="rate">4,9</h3>
                        </div>
                        <div class="d-flex flex-column">
                            <div class="d-inline-flex">
                                <div class="rate-icon" id="rate-1"></div>
                                <div class="rate-icon" id="rate-2"></div>
                                <div class="rate-icon" id="rate-3"></div>
                                <div class="rate-icon" id="rate-4"></div>
                                <div class="rate-icon" id="rate-5"></div>
                            </div>
                            <div>
                                <p class="text-common" id="reviews-cnt">6 оценок</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-center align-items-center mx-1 w-100">
                    <button id="make-route-btn" class="btn btn-filled h-auto" onclick="make_route_to_cur()">
                        <p class="btn-text"><img src="../../ui-kit/svg/white_gps.svg"> Построить маршрут</p>
                    </button>
                    <button id='excursion-btn2' class="btn btn-filled" onclick="excursion_start()">
                        <p class="btn-text">Начать экскурсию</p>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="info2">
        <div id='popup-wrapper' class="position-fixed" style="z-index: 3;bottom:0; width:100%;">
            <div onclick='toggle_collapse()'
                class="px-3 near-popup d-inline-flex justify-content-between align-items-center">
                <div id="sobaka-head" class="dog-img-big"></div>
                <div id='near-popup-text' style='display:flex;' class="justify-content-center align-items-center h-100">
                    <div class="d-flex flex-column">
                        <div>
                            <h3 class="text-bold">Вы рядом с меткой!</h3>
                        </div>
                        <div>
                            <h3 class="text-description">Памятник медведю "Символ России, легенда Ярославля"</h3>
                        </div>
                    </div>
                </div>
                <div style="height: 100%">
                    <div id="less-sign" class="less-sign"></div>
                </div>
            </div>
            <div id='inner-reviews' class="reviews">
                <div class="justify-content-center align-items-center w-100 p-3">
                    <button id='excursion-btn' class="btn btn-filled" onclick="excursion_start()">
                        <p class="btn-text">Начать экскурсию</p>
                    </button>
                </div>
                <script>
                    function excursion_start() {
                        localStorage.excursion_id = parseInt([localStorage.getItem('prev_place')]) + 1;
                        if(localStorage.getItem('passed') != null && localStorage.getItem('passed') != 'undefined'){
                            let favs = localStorage.getItem('passed');
                            favs = JSON.parse(favs);
                            favs.push(localStorage.excursion_id);
                            favs = JSON.stringify(favs)
                            localStorage.setItem('passed',favs);
                        }else{
                            localStorage.setItem('passed',JSON.stringify([localStorage.excursion_id]));
                        }
                        redirect_excursion_start();
                    }
                </script>
            </div>
        </div>
    </div>
    <div id="info3" style="display: none; position: fixed; top:0;">
        <div id="progress-wrapper" style="width: 100%;"
            class="geopoint-popup position-fixed d-flex flex-column justify-content-start align-items-center">
            <div class="progress-popup d-flex align-items-around justify-content-between p-3"
                style="margin-left:20px; max-width: 250px; ">
                <div class="d-flex justify-content-center align-items-center" onclick="progress_end()">
                    <div class="close-icon2"></div>
                    <p style="color:rgba(189, 189, 189, 1); font-size: 14px;padding-left:0.5rem; margin-bottom: 0;">
                        Завершить экскурсию
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div id="search-history">
        <div class="search-history">
            <div class="d-flex flex-column px-2" id="search-results1">
                <!--                <div><a href="#">-->
                <!--                    <div class="bg-white w-100 d-inline-flex align-items-center p-2">-->
                <!--                        <div class="time-icon me-3"></div>-->
                <!--                        <div><h3 class="text-common">Свободы</h3></div>-->
                <!--                    </div>-->
                <!--                </a></div>-->
                <!--                <div><a href="#">-->
                <!--                    <div class="bg-white w-100 d-inline-flex p-2">-->
                <!--                        <div class="time-icon me-3"></div>-->
                <!--                        <div><h3 class="text-common">Миллениум</h3></div>-->
                <!--                    </div>-->
                <!--                </a></div>-->
            </div>
        </div>
    </div>
    <script>
        var opened = false;
        var popup_collapsed = false;

        // Открытие, закрытие попап окон
        function toggle_collapse() {
            if (popup_collapsed) {
                setTimeout(() => {
                    document.getElementsByClassName('near-popup')[0].style.borderBottom = '2px solid rgba(243, 243, 243, 1)';
                    document.getElementsByClassName('near-popup')[0].classList.remove('px-3');
                    document.getElementsByClassName('near-popup')[0].classList.add('px-3');
                    document.getElementsByClassName('near-popup')[0].style.borderRadius = 'unset';
                    document.getElementById('near-popup-text').style.display = 'flex';
                    document.getElementById('inner-reviews').style.display = 'block';
                    document.getElementById('popup-wrapper').style.bottom = '0px';
                    document.getElementById('less-sign').style.display = 'block';
                }, 600);
                document.getElementById('sobaka-head').classList.remove('dog-img-big-small');
                document.getElementById('sobaka-head').classList.add('dog-img-big');
                document.getElementById('popup-wrapper').style.width = '100%';

            } else {
                setTimeout(() => {
                    document.getElementsByClassName('near-popup')[0].style.borderBottom = '0';
                    document.getElementsByClassName('near-popup')[0].classList.remove('px-3');
                    document.getElementsByClassName('near-popup')[0].style.borderRadius = '12px';
                    document.getElementById('near-popup-text').style.display = 'none';
                    document.getElementById('inner-reviews').style.display = 'none';
                    document.getElementById('popup-wrapper').style.bottom = opened ? '210px' : '82px';
                    document.getElementById('less-sign').style.display = 'none';
                }, 0);
                document.getElementById('sobaka-head').classList.remove('dog-img-big');
                document.getElementById('sobaka-head').classList.add('dog-img-big-small');
                document.getElementById('popup-wrapper').style.width = 'calc(70px)';
            }
            popup_collapsed = !popup_collapsed;
        }

        // Открытие, закрытие строчки поиска
        function search_history_open() {
            document.getElementById('search-history').style.display = 'block';
            document.getElementById('search-icon').classList.add('grey-close-icon');
            document.getElementById('search-icon').classList.remove('grey-search-icon');
        }
        function search_history_close() {
            document.getElementById('search-history').style.display = 'none';
            document.getElementById('search-icon').classList.remove('grey-close-icon');
            document.getElementById('search-icon').classList.add('grey-search-icon');
        }

        // Открытие, закрытие краткой информации о геоточке
        function collapse_open() {
            document.getElementById("info").style.display = 'block';
            document.getElementById('info-name').innerHTML = locs[localStorage.getItem('prev_place')][2];
            // document.getElementById('info-address').innerHTML = locs[localStorage.getItem('prev_place')][3];
            document.getElementById('info-distance').innerHTML = `${calc_distance_to_geopoint(localStorage.getItem('prev_place'))} км от вас`;
            document.getElementById('info-description').innerHTML = locs[localStorage.getItem('prev_place')][3];
            document.getElementById('info-photo').style.background = `url(https://trip.backend.xredday.ru/${locs[localStorage.getItem('prev_place')][4]})`;
            localStorage.setItem('g_distance', calc_distance_to_geopoint(localStorage.getItem('prev_place')));

            api_getrev(localStorage.getItem('prev_place'), localStorage.getItem('auth_key')).then((res) => {
                let rate = parseFloat(res[0]).toFixed(1);
                document.getElementById('reviews-cnt').innerHTML = `отзывов: ${res[1].length}`;
                document.getElementById('rate').innerText = rate;
                [1, 2, 3, 4, 5].forEach((el) => {
                    document.getElementById(`rate-${el}`).className = (rate >= el) ? "rate-icon" : "unrate-icon";
                })
            }, () => console.log('error'));
            popup_collapsed = !popup_collapsed;
            toggle_collapse();
        }
        function collapse_close() {
            document.getElementById("info").style.display = 'none';
            popup_collapsed = !popup_collapsed;
            toggle_collapse();
        }
        function collapse_toggle(g_id) {
            opened = !opened;
            console.log(g_id);
            if (localStorage != undefined) {
                if (opened) {
                    localStorage.setItem('prev_place', g_id);
                    collapse_open();
                }
                else {
                    localStorage.removeItem('prev_place');
                    collapse_close();
                }
            }
        }

        // Изменение приближения карты
        function update_zoom() {
            if (localStorage != undefined) {
                if (localStorage.getItem('zoomControl') == 'true') {
                    document.getElementById('zoomControl').style.display = 'block';
                } else {
                    document.getElementById('zoomControl').style.display = 'none';
                }
            }
        }

        // Обновление прогресса маршрута
        function update_progress() {
            if (cur_route_id != -1) {
                localStorage.setItem('route_id', cur_route_id);
                localStorage.setItem('route_place', cur_route_place);
                document.getElementById('info3').style.display = 'block';
                let flag = true;
                let favs = localStorage.getItem('passed');
                if (favs == null || favs == 'undefined'){
                    favs = []
                }else{
                    favs = JSON.parse(favs);
                }
                for(let i = 0;i<routes[cur_route_id].length;i++){
                    if(!favs.includes(`${routes[cur_route_id][i]+1}`)){
                        flag = false;
                    }
                }
                if(flag){
                    localStorage.removeItem('route_id');
                    localStorage.removeItem('route_place');
                    localStorage.removeItem('route_start');
                    for(let i = 0;i<routes[cur_route_id].length;i++){
                        favs = favs.filter(function (e) {
                            return e != `${routes[cur_route_id][i]+1}`;
                        });
                    }
                    favs = JSON.stringify(favs)
                    localStorage.setItem('passed',favs);
                   redirect_excursion_finale();
                }
            } else {
                document.getElementById('info3').style.display = 'none';
            }
        }

        // Обработчик клика по точке на прогресс баре маршрутов
        function progress_clicked(num) {
            cur_route_place = num;
            update_markers();
        }
        function progress_end() {
            localStorage.removeItem('route_id');
            localStorage.removeItem('route_place');
            localStorage.removeItem('route_start');
            cur_route_id = -1;
            cur_route_place = -1;
            update_markers();
            redirect_excursion_finale();
        }
        if (localStorage != undefined) {
            localStorage.setItem('prev_page', '/screens/Map/map.html');
        }
    </script>

    <script src="../../cordova.js"></script>
    <script src="../api.js"></script>
    <script src="../../ui-kit/js/redirects.js"></script>
    <script src="../../ui-kit/js/deeplinks.js"></script>
    <script src="../../ui-kit/js/geopoints.js"></script>
    <script src="../../ui-kit/js/map.js"></script>
</body>

</html>