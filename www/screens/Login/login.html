<html lang="en">

<!-- TODO: добавить валидацию ключа -->
<script>
    if (localStorage != undefined) {
        auth_key = localStorage.getItem('auth_key') != null;
        if (auth_key) {
            window.location.href = '../Map/map.html';
        }
    }
</script>


<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <title>loginka</title>
    <style>
        body {
            background: url("../../ui-kit/svg/background_orange.svg");
            background-repeat: no-repeat;
            background-size: cover;
        }
    </style>
    <link rel="stylesheet" href="../../ui-kit/css/styles.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="../../ui-kit/css/bootstrap.css">
    <script src="../../ui-kit/js/redirects.js"></script>
</head>

<body style="height: 100vh;">
    <div
        style="display: flex; flex-direction: column; align-items:center; justify-content: center; height: 100%; padding: 3.5rem;">
        <h1 class="text-attention"
            style="text-align: center; font-family: gilroy; font-weight: 700; color:rgba(255, 255, 255, 1); max-width: 470px;">
            Войдите
            или зарегистрируйтесь 
        </h1>
        <div class="d-inline-flex align-items-center" id="error-msg">
            <div class="danger-icon"></div>
            <div id="error-msg-text" style="color:white">Неправильный логин или пароль</div>
        </div>
        <div class="mb-3">
            <label for="email_input" class="form-label"></label>
            <input type="email" class="form-control" style="border: 1.5px solid #C7C7C7;
        height: 50px; " id="email_input" placeholder="name@example.com">
        </div>

        <div class="mb-3">
            <label for="password_field" class="form-label"></label>
            <input type="password" class="form-control" style="border: 1.5px solid #C7C7C7; height: 50px;"
                id="password_field" placeholder="******">
        </div>

        <a href="../forget%20password/foget.html"
            style="color:rgba(57, 57, 57, 1); text-decoration: none; position:relative; left: 5rem;">Забыли пароль?</a>

        <!-- <button class="btn btn-hollow mb-3" id="login_button" onclick="location.href='../Map/map.html'" style="border-radius:12px; margin-top: 4rem;"> -->

        <button class="btn btn-hollow mb-3" id="login_button" onclick="login()"
            style="border-radius:12px; margin-top: 4rem;" disabled>
            <p class="btn-text">Войти</p>
        </button>
        <button class="btn btn-hollow2" onclick="redirect_registration()"
            style="border-radius:12px;">
            <p class="btn-text">Зарегистрироваться</p>
        </button>

    </div>
</body>

<script>
    const validateEmail = (email) => {
        var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
        // return true;
    };

    errorMessage = document.getElementById("error-msg");
    errorMessage.style.visibility = "hidden";
    loginButton = document.getElementById("login_button");
    emailField = document.getElementById("email_input");
    passwordField = document.getElementById("password_field");
    const callbackFunction = function () {
        emailField.classList.remove("line-success");
        emailField.classList.remove("line-danger");
        passwordField.classList.remove("line-success");
        loginButton.classList.remove("btn-highlight");
        loginButton.classList.remove("btn-filled");
        loginButton.classList.add("btn-hollow");
        loginButton.disabled = true;

        console.log(emailField.value);
        if (passwordField.value.length > 3) {
            passwordField.classList.add("line-success");
        }
        if (validateEmail(emailField.value)) {
            emailField.classList.add("line-success");

            if (passwordField.value.length > 3) {
                loginButton.classList.remove("btn-hollow");

                loginButton.classList.add("btn-highlight");
                loginButton.classList.add("btn-filled");
                loginButton.disabled = false;


            }
        } else if (emailField.value) {
            emailField.classList.add("line-danger");
        };
    };
    emailField.onchange = callbackFunction;
    passwordField.onchange = callbackFunction;

    callbackFunction();
</script>
<script src="../../cordova.js"></script>
<script>
    //window.location.href = '../Map/map.html';
    function login(email, password) {
        errorMessage.style.visibility = "hidden";

        if (!email) email = emailField.value;
        if (!password) password = passwordField.value;
        api_authorize(email, password);
    }

    function api_authorize(email, password) {
        // Recieves email and password in plain.

        cordovaHTTP.post("https://trip.backend.xredday.ru/",
            {
                'request':
                {
                    "action": "login",
                    "data": { "login": email, "pass": password }
                }
            },
            {},
            function (response) {
                // prints 200
                console.log(response.status);

                try {
                    console.log(response.data);
                    localStorage.setItem("auth_key", response.data);
                    if (response.data) {
                        redirect_home();
                    }



                } catch (e) {
                    console.error("JSON parsing error");
                }
            },
            function (response) {
                // prints 403
                console.log(response.status);
                errorMessage.style.visibility = "visible";
                //prints Permission denied
                console.log(response.data);

            }
        );

    }
</script>

</html>