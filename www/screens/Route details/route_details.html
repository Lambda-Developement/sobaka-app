<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../ui-kit/css/bootstrap.css">
    <link rel="stylesheet" href="../../ui-kit/css/styles.css">
    <link rel="stylesheet" href="styles.css">
    <title>RouteInfo</title>
</head>
<body onload="on_load()">


<div class="screen-hat">
    <button class="btn arrow-back">
        <a href="../Routes/routes.html">
            <img src="../../ui-kit/svg/arrow_back.svg" alt="arrow-back">
        </a>
    </button>
    <div class="mb-3">
        <h3 class="text-header">
            Маршруты
        </h3>
    </div>
</div>

<div class="container">
    <div class="image-frame my-3" id="route-logo">
    </div>
    <div class="panel panel-up">
        <h3 class="text-header text-start" id="route-name">Пешая прогулка</h3>
        <div class="d-flex flex-column">
            <div class="d-inline-flex align-items-center">
                <div><h3 class="text-description me-2">Дистанция: </h3></div>
                <div><p class="text-bold"> 6 km</p></div>
            </div>
            <div class="d-inline-flex align-items-center">
                <div><h3 class="text-description me-2">Время: </h3></div>
                <div><p class="text-bold"> 1 час 15 минут</p></div>
            </div>
        </div>
    </div>
    <div class="panel d-inline-flex justify-content-evenly align-items-center mb-1">
        <div class="d-flex flex-column justify-content-center align-items-center active" id="geoinfo">
            <div><h3 class="text-link"><a onclick="switch_geoinfo()">Обзор</a></h3></div>
            <div class="underliner"></div>
        </div>
        <div class="d-flex flex-column justify-content-center align-items-center" id="review">
            <div><h3 class="text-link"><a onclick="switch_review()">Отзывы</a></h3></div>
            <div class="underliner"></div>
        </div>
    </div>
    <div class="panel panel-down mb-2 geoinfo">
        <a href="#" onclick="collapse_toggle()"><div>
            <div class="d-inline-flex justify-content-between w-100">
                <div><h3 class="text-description mb-1">Описание маршрута</h3></div>
                <div class="dropdown-icon" id="dropdown"></div>
            </div>
            <div id="info">
                <p class="text-common" id="route-description">
                    Ярославский музей-заповедник — главная городская достопримечательность. За каменными стенами крепости 16 века расположен Спасо-Преображенский монастырь, в котором было найдено «Слово о полку Игореве».<br><br>Ярославский музей-заповедник подойдет тем, кто любит выставки, и тем, кто предпочитает просто бродить по городу. Здесь за одной стеной — восемь экспозиций. Есть выставка «Иконы Ярославля» с большой коллекцией русской иконописи и экспозиция, посвященная «Слову о полку Игореве». Но в целом в заповеднике я совсем не почувствовала монастырской строгости: там много светских выставок, например о природе и истории Ярославского края. Еще одна экспозиция посвящена русской ярмарке.
                </p>
            </div>
        </div></a>
    </div>
</div>
<div class="container" style="padding: 0" onclick="switch_review()">
    <div class="panel">
        <div class="panel-grey-up">
            <div class="d-inline-flex align-items-center">
                <div style="margin-right: 10px;">
                    <h3 class="text-attention">4,9</h3>
                </div>
                <div class="d-flex flex-column">
                    <div class="d-inline-flex">
                        <div class="rate-icon"></div>
                        <div class="rate-icon"></div>
                        <div class="rate-icon"></div>
                        <div class="rate-icon"></div>
                        <div class="rate-icon"></div>
                    </div>
                    <div>
                        <p class="text-common">6 оценок</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-grey-down">
            <h3 class="text-description mt-3 text-center">Оцените и напишите отзыв</h3>
            <div class="d-inline-flex justify-content-center container" >
                <div class="star-icon" id="star-rate-1" onclick="star_rate_clicked(this)"></div>
                <div class="star-icon" id="star-rate-2" onclick="star_rate_clicked(this)"></div>
                <div class="star-icon" id="star-rate-3" onclick="star_rate_clicked(this)"></div>
                <div class="star-icon" id="star-rate-4" onclick="star_rate_clicked(this)"></div>
                <div class="star-icon" id="star-rate-5" onclick="star_rate_clicked(this)"></div>
            </div>
        </div>
        <div class="w-100 review">
            <h3 class="text-common my-3" id="reviews-count">Отзывов: 2</h3>
            <div id="reviews-here">
                <div class="review d-flex flex-column mb-3">
                    <div class="d-inline-flex align-items-center mb-2">
                        <div class="circle d-flex justify-content-center align-items-center me-3"><div><h3 class="text-attention in-circle">А</h3></div></div>
                        <div><h3 class="text-common">Александр</h3></div>
                    </div>
                    <div class="d-inline-flex align-items-center mb-2">
                        <div class="d-inline-flex justify-content-center align-items-center me-3">
                            <div class="rate-icon small"></div>
                            <div class="rate-icon small"></div>
                            <div class="rate-icon small"></div>
                            <div class="rate-icon small"></div>
                            <div class="rate-icon small"></div>
                        </div>
                        <div><h3 class="text-description">12 января 2022 г.</h3></div>
                    </div>
                    <div>
                        <p class="text-common">
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Magna nulla convallis convallis porta. Sed eget scelerisque hac nec dignissim morbi eu faucibus. Eget aliquet magna nulla convallis convallis...
                        </p>
                    </div>
                </div>
                <div class="review d-flex flex-column mb-3">
                    <div class="d-inline-flex align-items-center mb-2">
                        <div class="circle d-flex justify-content-center align-items-center me-3"><div><h3 class="text-attention in-circle">В</h3></div></div>
                        <div><h3 class="text-common">Владислав</h3></div>
                    </div>
                    <div class="d-inline-flex align-items-center mb-2">
                        <div class="d-inline-flex justify-content-center align-items-center me-3">
                            <div class="rate-icon small"></div>
                            <div class="rate-icon small"></div>
                            <div class="rate-icon small"></div>
                            <div class="rate-icon small"></div>
                            <div class="rate-icon small"></div>
                        </div>
                        <div><h3 class="text-description">11 января 2022 г.</h3></div>
                    </div>
                    <div>
                        <p class="text-common">
                            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Magna nulla convallis convallis porta. Sed eget scelerisque hac nec dignissim morbi eu faucibus. Eget aliquet magna nulla convallis convallis...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="spacer"></div>
</div>

<div class="btn-panel">
    <div class="d-inline-flex justify-content-center w-100 align-items-center">
        <div><button class="btn btn-hollow2 me-2" onclick="btn_click()"><p class="btn-text" id="review-text">Начать экскурсию</p></button> </div>
    </div>
</div>
<script src="../../cordova.js"></script>
<script src="../../ui-kit/js/geopoints.js"></script>
<script>
    var opened = false;
    var rate = 5;
    var review_btn_state = true;
    var review_count = 0;
    var review_opened = false;
    function on_load(){
        let s = 'Пешая прогулка'
        let d = 'Ярославский музей-заповедник — главная городская достопримечательность. За каменными стенами крепости 16 века расположен Спасо-Преображенский монастырь, в котором было найдено «Слово о полку Игореве».<br><br>Ярославский музей-заповедник подойдет тем, кто любит выставки, и тем, кто предпочитает просто бродить по городу. Здесь за одной стеной — восемь экспозиций. Есть выставка «Иконы Ярославля» с большой коллекцией русской иконописи и экспозиция, посвященная «Слову о полку Игореве». Но в целом в заповеднике я совсем не почувствовала монастырской строгости: там много светских выставок, например о природе и истории Ярославского края. Еще одна экспозиция посвящена русской ярмарке.'
        let l = "url('../../ui-kit/img/icg4y3j7.bmp')";
        if(localStorage != undefined){
            if(localStorage.getItem('route_id') != null){
                t = localStorage.getItem('route_id')
                if(t=='0'){
                }else if(t=='2'){
                    s = 'Per aspera ad Astra'
                    d = 'В стенах планетария прекрасно уживаются Музей истории космонавтики, интерактивные выставки, звездный кинотеатр, высокотехнологичный телескоп и 5D аттракционы. Центр проводит уроки и круглые столы для школьников, различные конференции и семинары на космическую тематику и активно участвует в популяризации науки.'
                    l = "url('../../ui-kit/img/zsmhme2t.bmp')";
                }else if(t=='1'){
                    s = 'Ярославские купола'
                    d = 'Ярославль известен, как столица Золотого кольца, но в городе есть не только купеческие особняки, старинные соборы и торговые ряды. Представлено много возможностей подобрать маршрут экскурсии на свой вкус, в том числе посетить массу достойных и весьма интересных мест: пешеходные пространства, симпатичные парки, шикарную набережную, рестораны и бары. В Ярославле был основан первый русский профессиональный театр, здесь раньше всего появился местный журнал, одним из первых пошел русский трамвай, также этот город является непревзойденным лидером по количеству памятников старины.'
                    l = "url('../../ui-kit/img/lvsls0y5.bmp')";
                }
            }
        }
        document.getElementById('route-name').innerHTML = s;
        document.getElementById('route-description').innerHTML = d;
        document.getElementById('route-logo').style.backgroundImage = l;
    }
    function collapse_open(){
        document.getElementById("info").style.height = "fit-content";
        document.getElementById("dropdown").classList.add("dropdown-icon-down");
    }
    function collapse_close(){
        document.getElementById("info").style.height = "102px";
        document.getElementById("dropdown").classList.remove("dropdown-icon-down");
    }
    function collapse_toggle(){
        opened = !opened;
        opened ? collapse_open() : collapse_close();
    }
    function switch_review(){
        document.getElementById('geoinfo').classList.remove('active');
        document.getElementById('review').classList.add('active');
        var temp = document.getElementsByClassName("geoinfo");
        for(var i = 0; i < temp.length; i++)
        {
            temp[i].style.display = 'none';
        }
        temp = document.getElementsByClassName("review");
        for(var i = 0; i < temp.length; i++)
        {
            temp[i].style.display = 'block';
        }
        document.getElementById('review-text').innerHTML = "Написать отзыв";
        review_opened = true;
    }
    function switch_geoinfo(){
        document.getElementById('review').classList.remove('active');
        document.getElementById('geoinfo').classList.add('active');
        var temp = document.getElementsByClassName("geoinfo");
        for(var i = 0; i < temp.length; i++)
        {
            temp[i].style.display = 'block';
        }
        temp = document.getElementsByClassName("review");
        for(var i = 0; i < temp.length; i++)
        {
            temp[i].style.display = 'none';
        }
        document.getElementById('review-text').innerHTML = "Начать экскурсию";
        review_opened = false;
    }
    function get_user_name() {
        cordovaHTTP.post("https://trip.backend.xredday.ru/",
            {
                'request':
                    {
                        "action": "userdata",
                        "user_key":localStorage.getItem('auth_key')
                    }
            },
            {},
            function (response) {
                // prints 200
                console.log(response.status);
                try {
                    console.log(response.data);
                    a = JSON.parse(response.data)[2];
                    console.log(a);
                    localStorage.setItem('name',a);
                } catch (e) {
                    console.error("JSON parsing error");
                }
            },
            function (response) {
                // prints 403
                console.log(response.status);
                errorMessage.style.visibility = "visible";
                //prints Permission denied
                console.log(response.data);
            }
        );
    }
    function get_user_id(mark,review) {
        cordovaHTTP.post("https://trip.backend.xredday.ru/",
            {
                'request':
                    {
                        "action": "userdata",
                        "user_key":localStorage.getItem('auth_key')
                    }
            },
            {},
            function (response) {
                // prints 200
                console.log(response.status);
                try {
                    console.log(response.data);
                    a = JSON.parse(response.data)[0];
                    add_review(a,mark,review);
                } catch (e) {
                    console.error("JSON parsing error");
                }
            },
            function (response) {
                // prints 403
                console.log(response.status);
                errorMessage.style.visibility = "visible";
                //prints Permission denied
                console.log(response.data);
            }
        );
    }
    function add_review(id,mark,review) {
        cordovaHTTP.post("https://trip.backend.xredday.ru/",
            {
                'request':
                    {
                        "action": "crrev",
                        "user_key":localStorage.getItem('auth_key'),
                        "data": { "id":id,"mark":mark,"review":review }
                    }
            },
            {},
            function (response) {
                // prints 200
                console.log(response.status);
                try {
                    console.log(response.data);
                } catch (e) {
                    console.error("JSON parsing error");
                }
            },
            function (response) {
                // prints 403
                console.log(response.status);
                errorMessage.style.visibility = "visible";
                //prints Permission denied
                console.log(response.data);
            }
        );
    }
    function btn_click(){
        if (!review_opened){
            document.location.href='../Geoposition/home.html';
            return;
        }
        let name = "Роман";
        if(localStorage != undefined){
            name = Boolean(localStorage.getItem('name')) ? localStorage.getItem('name') : 'Роман';
        }
        if(review_btn_state){
            document.getElementById('reviews-here').innerHTML += "" +
                "<div id='review-"+(review_count)+"' class=\"review d-flex flex-column mb-3\">\n" +
                "                    <div class=\"d-inline-flex align-items-center mb-2\">\n" +
                "                        <div class=\"circle d-flex justify-content-center align-items-center me-3\"><div><h3 class=\"text-attention in-circle\">"+name[0].toUpperCase()+"</h3></div></div>\n" +
                "                        <div><h3 class=\"text-common\">"+name+"</h3></div>\n" +
                "                    </div>\n" +
                "                    <div class=\"d-inline-flex align-items-center mb-2\">\n" +
                "                        <div class=\"d-inline-flex justify-content-center align-items-center me-3\">\n" +
                "                            <div class=\"rate-icon small\" id='rate-1' onclick='rate_clicked(this)'></div>\n" +
                "                            <div class=\"rate-icon small\" id='rate-2' onclick='rate_clicked(this)'></div>\n" +
                "                            <div class=\"rate-icon small\" id='rate-3' onclick='rate_clicked(this)'></div>\n" +
                "                            <div class=\"rate-icon small\" id='rate-4' onclick='rate_clicked(this)'></div>\n" +
                "                            <div class=\"rate-icon small\" id='rate-5' onclick='rate_clicked(this)'></div>\n" +
                "                        </div>\n" +
                "                    </div>\n" +
                "                    <div class=\"new-review-input\">\n" +
                "                        <input type=\"text\" class=\"form-control\" id='review-input' placeholder=\"...\">\n" +
                "                    </div>\n" +
                "                </div>";
            document.getElementById('review-text').innerHTML = 'Добавить';
        }else{
            let prev_review = document.getElementById('review-input').value;
            get_user_id(rate,document.getElementById('review-input').value); // send add review to backend function chain
            document.getElementById('review-'+(review_count)).remove();
            document.getElementById('reviews-here').innerHTML += "" +
                "<div id='review-"+(review_count)+"' class=\"review d-flex flex-column mb-3\">\n" +
                "                    <div class=\"d-inline-flex align-items-center mb-2\">\n" +
                "                        <div class=\"circle d-flex justify-content-center align-items-center me-3\"><div><h3 class=\"text-attention in-circle\">"+name[0].toUpperCase()+"</h3></div></div>\n" +
                "                        <div><h3 class=\"text-common\">"+name+"</h3></div>\n" +
                "                    </div>\n" +
                "                    <div class=\"d-inline-flex align-items-center mb-2\">\n" +
                "                        <div class=\"d-inline-flex justify-content-center align-items-center me-3\">\n" +
                "                            <div class=\""+(rate >= 1 ? "rate-icon" : "star-icon-rate")+" small\"></div>\n" +
                "                            <div class=\""+(rate >= 2 ? "rate-icon" : "star-icon-rate")+" small\"></div>\n" +
                "                            <div class=\""+(rate >= 3 ? "rate-icon" : "star-icon-rate")+" small\"></div>\n" +
                "                            <div class=\""+(rate >= 4 ? "rate-icon" : "star-icon-rate")+" small\"></div>\n" +
                "                            <div class=\""+(rate >= 5 ? "rate-icon" : "star-icon-rate")+" small\"></div>\n" +
                "                        </div>\n" +
                "                        <div><h3 class=\"text-description\">Только что</h3></div>\n" +
                "                    </div>\n" +
                "                    <div>\n" +
                "                        <p class=\"text-common\">\n" +
                "                            "+prev_review+"\n" +
                "                        </p>\n" +
                "                    </div>\n" +
                "                </div>";
            document.getElementById('review-text').innerHTML = 'Написать отзыв';
            review_count++;
            document.getElementById('reviews-count').innerHTML = "Отзывов: " + (review_count+2) ;
        }
        review_btn_state = !review_btn_state;
    }
    function rate_clicked(el){
        ['1','2','3','4','5'].forEach(b=>{
            if(el.id == 'rate-'+b){
                rate = parseInt(b);
            }
        })
        update_icons();

    }
    function star_rate_clicked(el){
        ['1','2','3','4','5'].forEach(b=>{
            if(el.id == 'star-rate-'+b){
                rate = parseInt(b);
                if(review_btn_state)
                    btn_click();
            }
        })
        update_icons();

    }
    function update_icons(){
        for(i = 1;i<=5;i++){
            if(i <= rate){
                document.getElementById('star-rate-'+i).classList.remove('star-icon');
                document.getElementById('star-rate-'+i).classList.add('rate-icon-big')
            }else{
                document.getElementById('star-rate-'+i).classList.remove('rate-icon-big');
                document.getElementById('star-rate-'+i).classList.add('star-icon');
            }
        }
        for(i = 1;i<=5;i++){
            if(i <= rate){
                document.getElementById('rate-'+i).classList.remove('star-icon-rate');
                document.getElementById('rate-'+i).classList.add('rate-icon')
            }else{
                document.getElementById('rate-'+i).classList.remove('rate-icon');
                document.getElementById('rate-'+i).classList.add('star-icon-rate');
            }
        }
    }
    setTimeout(()=>{
        get_user_name();
    },1000);
</script>
</body>
</html>