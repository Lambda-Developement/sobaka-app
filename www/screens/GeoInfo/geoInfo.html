<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../ui-kit/css/bootstrap.css">
    <link rel="stylesheet" href="../../ui-kit/css/styles.css">
    <link rel="stylesheet" href="styles.css">
    <title>GeoInfo</title>

</head>

<body>


    <div class="screen-hat">
        <button class="btn arrow-back" style="position:relative">
            <a href="../Map/map.html">
                <img src="../../ui-kit/svg/arrow_back.svg" alt="arrow-back">
            </a>
        </button>
        <div class="mb-3">
            <h3 class="text-header" id="text-header" style="text-align:center; padding-right: 15%;">
                Парк 1000 летия
            </h3>
        </div>
    </div>

    <div class="container">
        <div class="image-frame my-3" id="info-photo">
            <div class="ontop d-inline-flex align-items-center">
                <div class="photos-icon"></div>
                <div>
                    <p class="text-attention">1</p>
                </div>
            </div>
        </div>
        <div class="panel panel-up">
            <h3 class="text-bold" id="info-name">Памятник медведю</h3>
            <h3 class="text-description" id="info-description">Россия, Ярославль, улица Которосльная набережная</h3>
            <div class="d-inline-flex justify-content-between align-items-center " style="width: 100%">
                <div>
                    <h3 class="text-description" style="color: rgba(168, 168, 168, 1)">Круглосуточно</h3>
                </div>
                <div>
                    <h3 class="text-description" id="info-distance" style="color: rgba(168, 168, 168, 1)">0.6 km</h3>
                </div>
            </div>
        </div>
        <div class="panel d-inline-flex justify-content-evenly align-items-center mb-1">
            <div class="d-flex flex-column justify-content-center align-items-center active" id="geoinfo">
                <div>
                    <h3 class="text-link"><a onclick="switch_geoinfo()">Обзор</a></h3>
                </div>
                <div class="underliner"></div>
            </div>
            <div class="d-flex flex-column justify-content-center align-items-center" id="review">
                <div>
                    <h3 class="text-link"><a onclick="switch_review()">Отзывы</a></h3>
                </div>
                <div class="underliner"></div>
            </div>
        </div>
        <div class="panel panel-down mb-2 geoinfo">
            <a href="#" onclick="collapse_toggle()">
                <div>
                    <div class="d-inline-flex justify-content-between w-100">
                        <div>
                            <h3 class="text-description mb-1">История</h3>
                        </div>
                        <div class="dropdown-icon" id="dropdown"></div>
                    </div>
                    <div id="info">
                        <p class="text-common">
                            По преданию, именно медведь вышел навстречу Ярославу Мудрому при завоевании города — и был
                            зарублен секирой. Так великий князь расправился с языческим символом города и принес в него
                            православную веру.<br><br><br>Монумент «Символ России, легенда Ярославля» установлен в честь
                            тысячелетия города и находится рядом со Спасо-Преображенским монастырем. Каждый час с 9 до
                            21 бронзовый медведь натурально рычит, приводя в восторг детей. Им, кстати, официально
                            разрешено забираться на животное.
                        </p>
                    </div>
                </div>
            </a>
        </div>
    </div>
    <div class="container" style="padding: 0">
        <div class="panel" onclick="switch_review()">
            <div class="panel-grey-up">
                <div class="d-inline-flex align-items-center">
                    <div style="margin-right: 10px;">
                        <h3 class="text-attention" id="average-score">4,9</h3>
                    </div>
                    <div class="d-flex flex-column">
                        <div class="d-inline-flex">
                            <div class="rate-icon" id="rate-1"></div>
                            <div class="rate-icon" id="rate-2"></div>
                            <div class="rate-icon" id="rate-3"></div>
                            <div class="rate-icon" id="rate-4"></div>
                            <div class="rate-icon" id="rate-5"></div>
                        </div>
                        <div>
                            <p class="text-common" id="reviews-cnt">6 оценок</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel-grey-down">
                <h3 class="text-description mt-3 text-center">Оцените и напишите отзыв</h3>
                <div class="d-inline-flex justify-content-center container">
                    <div class="star-icon" id="star-rate-1" onclick="star_rate_clicked(this)"></div>
                    <div class="star-icon" id="star-rate-2" onclick="star_rate_clicked(this)"></div>
                    <div class="star-icon" id="star-rate-3" onclick="star_rate_clicked(this)"></div>
                    <div class="star-icon" id="star-rate-4" onclick="star_rate_clicked(this)"></div>
                    <div class="star-icon" id="star-rate-5" onclick="star_rate_clicked(this)"></div>
                </div>
            </div>
            <div class="w-100 review">
                <h3 class="text-common my-3" id="reviews-count">Отзывов: 2</h3>
                <div id="reviews-here">

                </div>
            </div>
        </div>
        <div class="spacer"></div>
    </div>

    <div class="btn-panel">
        <div class="d-inline-flex justify-content-center w-100">
            <div class="geoinfo"><button class="btn btn-hollow2 me-2" onclick="get_route()">Маршрут</button> </div>
            <div class="geoinfo"><button class="btn btn-hollow" onclick="get_route()">Отсюда</button> </div>
<!--            <div class="geoinfo"><button class="btn btn-hollow ms-2">-->
<!--                    <div class="download-icon"></div>-->
<!--                </button> </div>-->
            <div class="review"><button class="btn btn-filled" id="add_btn" onclick="review_btn_click()">
                    <p class="btn-text"><img src="../../ui-kit/svg/icon_white.svg"> <span id="review-text">Добавить
                            отзыв</span></p>
                </button></div>
        </div>
    </div>
    <script src="../../cordova.js"></script>
    <script>
        var opened = false;
        var rate = 5;
        var review_btn_state = true;
        var review_count = 0;
        var prev_place = null;
        if (localStorage != undefined) {
            if (localStorage.getItem('prev_place') != null) {
                prev_place = localStorage.getItem('prev_place');
            }
        }

        // Получение маршрута
        function get_route() {
            localStorage.setItem('make_route', prev_place);
            redirect_home();
        }

        // Открытие, закрытие попап окон
        function collapse_open() {
            document.getElementById("info").style.height = "fit-content";
            document.getElementById("dropdown").classList.add("dropdown-icon-down");
        }
        function collapse_close() {
            document.getElementById("info").style.height = "102px";
            document.getElementById("dropdown").classList.remove("dropdown-icon-down");
        }
        function collapse_toggle() {
            opened = !opened;
            opened ? collapse_open() : collapse_close();
        }

        // Переключение в режим отызвов
        function switch_review() {
            document.getElementById('geoinfo').classList.remove('active');
            document.getElementById('review').classList.add('active');
            var temp = document.getElementsByClassName("geoinfo");
            for (var i = 0; i < temp.length; i++) {
                temp[i].style.display = 'none';
            }
            temp = document.getElementsByClassName("review");
            for (var i = 0; i < temp.length; i++) {
                temp[i].style.display = 'block';
            }
        }

        // Переключение в режим осмотра геоточки
        function switch_geoinfo() {
            document.getElementById('review').classList.remove('active');
            document.getElementById('geoinfo').classList.add('active');
            var temp = document.getElementsByClassName("geoinfo");
            for (var i = 0; i < temp.length; i++) {
                temp[i].style.display = 'block';
            }
            temp = document.getElementsByClassName("review");
            for (var i = 0; i < temp.length; i++) {
                temp[i].style.display = 'none';
            }
        }

        // Обработчик нажатия на кнопку добавить отзыв
        function review_btn_click() {
            let name = "Роман";
            if (localStorage != undefined) {
                name = Boolean(localStorage.getItem('name')) ? localStorage.getItem('name') : 'Роман';
            }
            if (review_btn_state) {
                document.getElementById('reviews-here').innerHTML += "" +
                    "<div id='review-" + (review_count) + "' class=\"review d-flex flex-column mb-3\">\n" +
                    "                    <div class=\"d-inline-flex align-items-center mb-2\">\n" +
                    "                        <div class=\"circle d-flex justify-content-center align-items-center me-3\"><div><h3 class=\"text-attention in-circle\">" + name[0].toUpperCase() + "</h3></div></div>\n" +
                    "                        <div><h3 class=\"text-common\">" + name + "</h3></div>\n" +
                    "                    </div>\n" +
                    // "                    <div class=\"d-inline-flex align-items-center mb-2\">\n" +
                    // "                        <div class=\"d-inline-flex justify-content-center align-items-center me-3\">\n" +
                    // "                            <div class=\"rate-icon small\" id='rate-1' onclick='rate_clicked(this)'></div>\n" +
                    // "                            <div class=\"rate-icon small\" id='rate-2' onclick='rate_clicked(this)'></div>\n" +
                    // "                            <div class=\"rate-icon small\" id='rate-3' onclick='rate_clicked(this)'></div>\n" +
                    // "                            <div class=\"rate-icon small\" id='rate-4' onclick='rate_clicked(this)'></div>\n" +
                    // "                            <div class=\"rate-icon small\" id='rate-5' onclick='rate_clicked(this)'></div>\n" +
                    // "                        </div>\n" +
                    // "                    </div>\n" +
                    "                    <div class=\"new-review-input\">\n" +
                    "                        <input type=\"text\" class=\"form-control\" id='review-input' placeholder=\"...\">\n" +
                    "                    </div>\n" +
                    "                </div>";
                document.getElementById('review-text').innerHTML = 'Добавить';
            } else {
                let prev_review = document.getElementById('review-input').value;
                api_crrev(localStorage.getItem('prev_place'), 0, rate, localStorage.getItem('auth_key'), prev_review).then((res) => {
                    console.log('done');
                }, () => console.log('error'));
                document.getElementById('review-' + (review_count)).remove();
                document.getElementById('reviews-here').innerHTML += "" +
                    "<div id='review-" + (review_count) + "' class=\"review d-flex flex-column mb-3\">\n" +
                    "                    <div class=\"d-inline-flex align-items-center mb-2\">\n" +
                    "                        <div class=\"circle d-flex justify-content-center align-items-center me-3\"><div><h3 class=\"text-attention in-circle\">" + name[0].toUpperCase() + "</h3></div></div>\n" +
                    "                        <div><h3 class=\"text-common\">" + name + "</h3></div>\n" +
                    "                    </div>\n" +
                    "                    <div class=\"d-inline-flex align-items-center mb-2\">\n" +
                    "                        <div class=\"d-inline-flex justify-content-center align-items-center me-3\">\n" +
                    "                            <div class=\"" + (rate >= 0 ? "rate-icon" : "star-icon-rate") + " small\"></div>\n" +
                    "                            <div class=\"" + (rate >= 1.5 ? "rate-icon" : "star-icon-rate") + " small\"></div>\n" +
                    "                            <div class=\"" + (rate >= 2.5 ? "rate-icon" : "star-icon-rate") + " small\"></div>\n" +
                    "                            <div class=\"" + (rate >= 3.5 ? "rate-icon" : "star-icon-rate") + " small\"></div>\n" +
                    "                            <div class=\"" + (rate >= 4.5 ? "rate-icon" : "star-icon-rate") + " small\"></div>\n" +
                    "                        </div>\n" +
                    "                        <div><h3 class=\"text-description\">Только что</h3></div>\n" +
                    "                    </div>\n" +
                    "                    <div>\n" +
                    "                        <p class=\"text-common\">\n" +
                    "                            " + prev_review + "\n" +
                    "                        </p>\n" +
                    "                    </div>\n" +
                    "                </div>";
                document.getElementById('review-text').innerHTML = 'Написать отзыв';
                review_count++;
                document.getElementById('reviews-count').innerHTML = "Отзывов: " + (review_count + 2);
                update_page();
            }
            review_btn_state = !review_btn_state;
        }

        // Обработчик нажатия на кнопку рейтинга
        function rate_clicked(el) {
            if (document.getElementById('add_btn').disabled != true){
                ['1', '2', '3', '4', '5'].forEach(b => {
                    if (el.id == 'rate-' + b) {
                        rate = parseInt(b);
                    }
                })
                update_icons();
            }

        }
        function star_rate_clicked(el) {
            if (document.getElementById('add_btn').disabled != true) {
                ['1', '2', '3', '4', '5'].forEach(b => {
                    if (el.id == 'star-rate-' + b) {
                        rate = parseInt(b);
                        if (review_btn_state)
                            review_btn_click();
                    }
                })
                update_icons();
            }
        }

        // Обновление рейтинга
        function update_icons() {
            for (i = 1; i <= 5; i++) {
                if (i <= rate) {
                    document.getElementById('star-rate-' + i).classList.remove('star-icon');
                    document.getElementById('star-rate-' + i).classList.add('rate-icon-big')
                } else {
                    document.getElementById('star-rate-' + i).classList.remove('rate-icon-big');
                    document.getElementById('star-rate-' + i).classList.add('star-icon');
                }
            }
            for (i = 1; i <= 5; i++) {
                if (i <= rate) {
                    document.getElementById('rate-' + i).classList.remove('star-icon-rate');
                    document.getElementById('rate-' + i).classList.add('rate-icon')
                } else {
                    document.getElementById('rate-' + i).classList.remove('rate-icon');
                    document.getElementById('rate-' + i).classList.add('star-icon-rate');
                }
            }
        }

        // Обновление отзывов
        function load_reviews(result) {
            rate = parseFloat(result[0]).toFixed(1);
            document.getElementById('average-score').innerHTML = rate;
            [1, 2, 3, 4, 5].forEach((el) => {
                document.getElementById(`rate-${el}`).className = (rate >= el) ? "rate-icon" : "unrate-icon";
            })
            let reviews = result[1];
            document.getElementById('reviews-count').innerHTML = `Отзывов: ${result[1].length}`;
            document.getElementById('reviews-cnt').innerHTML = `Оценок: ${result[1].length}`;
            console.log(reviews);
            reviews.forEach(el => {
                let name = el[0][0];
                console.log(el);
                console.log(name);
                if (name == localStorage.getItem('name')) {
                    document.getElementById('add_btn').disabled = true;
                    rate = el[1];
                    update_icons();
                }
                rate = el[1];
                let body = el[2];
                document.getElementById('reviews-here').innerHTML += "" +
                    "<div id='review-" + (review_count) + "' class=\"review d-flex flex-column mb-3\">\n" +
                    "                    <div class=\"d-inline-flex align-items-center mb-2\">\n" +
                    "                        <div class=\"circle d-flex justify-content-center align-items-center me-3\"><div><h3 class=\"text-attention in-circle\">" + name[0].toUpperCase() + "</h3></div></div>\n" +
                    "                        <div><h3 class=\"text-common\">" + name + "</h3></div>\n" +
                    "                    </div>\n" +
                    "                    <div class=\"d-inline-flex align-items-center mb-2\">\n" +
                    "                        <div class=\"d-inline-flex justify-content-center align-items-center me-3\">\n" +
                    "                            <div class=\"" + (rate >= 0 ? "rate-icon" : "star-icon-rate") + " small\"></div>\n" +
                    "                            <div class=\"" + (rate >= 1.5 ? "rate-icon" : "star-icon-rate") + " small\"></div>\n" +
                    "                            <div class=\"" + (rate >= 2.5 ? "rate-icon" : "star-icon-rate") + " small\"></div>\n" +
                    "                            <div class=\"" + (rate >= 3.5 ? "rate-icon" : "star-icon-rate") + " small\"></div>\n" +
                    "                            <div class=\"" + (rate >= 4.5 ? "rate-icon" : "star-icon-rate") + " small\"></div>\n" +
                    "                        </div>\n" +
                    // "                        <div><h3 class=\"text-description\">Только что</h3></div>\n" +
                    "                    </div>\n" +
                    "                    <div>\n" +
                    "                        <p class=\"text-common\">\n" +
                    "                            " + body + "\n" +
                    "                        </p>\n" +
                    "                    </div>\n" +
                    "                </div>";
                review_count++;
            });
        }

        // Обновление страницы
        function update_page() {
            document.getElementById('reviews-here').innerHTML = "";
            api_userdata(localStorage.getItem('auth_key')).then((userdata) => {
                localStorage.setItem('name', userdata[2]);
                api_data(localStorage.getItem('auth_key')).then((res) => {
                    document.getElementById('info-name').innerHTML = res[localStorage.getItem('prev_place')][2];
                    document.getElementById('info-description').innerHTML = res[localStorage.getItem('prev_place')][3];
                    document.getElementById('text-header').innerHTML = res[localStorage.getItem('prev_place')][2];
                    if (localStorage.getItem('g_distance') != null) {
                        document.getElementById('info-distance').innerHTML = `${localStorage.getItem('g_distance')} km`
                    }
                    document.getElementById('info-photo').style.background = `url(https://trip.backend.xredday.ru/${res[localStorage.getItem('prev_place')][4]})`;
                });
                api_getrev(localStorage.getItem('prev_place'), localStorage.getItem('auth_key')).then((res) => load_reviews(res), () => console.log('error'));
            });
        }
        document.addEventListener('deviceready', () => {
            update_page();
        });
    </script>
</body>
<script src="../api.js"></script>
<script src="../../ui-kit/js/redirects.js"></script>
<script src="../../ui-kit/js/deeplinks.js"></script>

</html>